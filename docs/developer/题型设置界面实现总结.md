# 题型设置界面实现总结

## 概述

基于 `cankao.py` 的设计，我们成功创建了一个完整的题型设置界面模块，实现了问卷星系统的模块化重构。

## 完成的工作

### 1. 项目结构重组

创建了清晰的模块化目录结构：

```
wjx-master/
├── core/                          # 核心功能模块
│   ├── parser/                    # 问卷解析模块
│   ├── filler/                    # 问卷填写模块
│   └── ai/                        # AI功能模块
├── config/                        # 配置管理
│   ├── settings/                  # 设置文件
│   └── profiles/                  # 配置文件
├── ui/                           # 用户界面
│   ├── components/               # UI组件
│   └── themes/                   # 主题文件
├── system/                       # 系统模块
├── tools/                        # 工具脚本
├── docs/                         # 文档
├── resources/                    # 资源文件
└── data/                         # 数据文件
```

### 2. 题型设置界面实现

#### 核心文件
- **`ui/components/question_settings_ui.py`**: 主要的题型设置界面类
- **`tools/test/test_question_settings_ui.py`**: 测试脚本

#### 支持的题型
1. **单选题** - 支持权重配置和随机选择
2. **多选题** - 支持独立概率、最小/最大选择数
3. **矩阵题** - 支持行列权重配置
4. **填空题** - 支持文本模板配置
5. **多项填空** - 支持多个文本模板
6. **排序题** - 支持位置权重配置
7. **下拉框** - 支持选项概率配置
8. **量表题** - 支持评分权重配置

#### 界面特性

##### 布局设计
- **标签页组织**: 使用Notebook按题型分类
- **表格布局**: 清晰的表格式界面
- **滚动支持**: Canvas + Scrollbar实现可滚动界面
- **鼠标滚轮**: 绑定鼠标滚轮支持

##### 交互功能
- **工具提示**: ToolTip类显示完整题目内容
- **快捷操作**: 偏左、偏右、随机、平均分布按钮
- **实时预览**: 题目预览和选项配置
- **分隔线**: 使用Separator分隔不同题目

##### 数据管理
- **配置存储**: 字典形式存储各题型配置
- **实时更新**: 界面变化实时反映到配置
- **验证机制**: 确保输入值的有效性

### 3. 基于cankao.py的设计特点

#### 界面布局
```python
# 标签页配置
question_types = [
    ('single_prob', "单选题", self.create_single_settings),
    ('multiple_prob', "多选题", self.create_multi_settings),
    ('matrix_prob', "矩阵题", self.create_matrix_settings),
    # ... 其他题型
]
```

#### 快捷操作
```python
# 四种快捷设置模式
ttk.Button(btn_group, text="偏左", command=lambda: self.set_question_bias("single", "left", q, e))
ttk.Button(btn_group, text="偏右", command=lambda: self.set_question_bias("single", "right", q, e))
ttk.Button(btn_group, text="随机", command=lambda: self.set_question_random("single", q, e))
ttk.Button(btn_group, text="平均", command=lambda: self.set_question_average("single", q, e))
```

#### 概率设置算法
```python
def set_question_bias(self, q_type, direction, q_num, entries):
    bias_factors = {
        "left": [0.4, 0.3, 0.2, 0.1, 0.05],    # 偏左分布
        "right": [0.05, 0.1, 0.2, 0.3, 0.4]   # 偏右分布
    }
```

### 4. 技术实现细节

#### ToolTip类
- 延迟显示机制
- 鼠标移动跟踪
- 自动隐藏功能

#### 滚动框架
```python
# 创建滚动框架
self.question_canvas = tk.Canvas(self.parent)
self.question_scrollbar = ttk.Scrollbar(self.parent, orient="vertical",
                                        command=self.question_canvas.yview)
self.scrollable_question_frame = ttk.Frame(self.question_canvas)
```

#### 鼠标滚轮绑定
```python
def bind_mousewheel_to_scrollbar(self, canvas):
    def _on_mousewheel(event):
        canvas.yview_scroll(int(-1 * (event.delta / 120)), "units")
    
    def _bind_mousewheel(event):
        canvas.bind_all("<MouseWheel>", _on_mousewheel)
    
    def _unbind_mousewheel(event):
        canvas.unbind_all("<MouseWheel>")
    
    canvas.bind('<Enter>', _bind_mousewheel)
    canvas.bind('<Leave>', _unbind_mousewheel)
```

### 5. 测试验证

创建了完整的测试脚本 `test_question_settings_ui.py`，包含：

- 示例配置数据
- 界面功能测试
- 配置保存/加载测试
- 清空配置测试

## 使用示例

### 基本使用
```python
import tkinter as tk
from ui.components.question_settings_ui import QuestionSettingsUI

# 创建主窗口
root = tk.Tk()
root.title("题型设置界面")
root.geometry("1200x800")

# 创建配置数据
config = {
    "single_prob": {"1": [0.3, 0.7]},
    "question_texts": {"1": "您的性别是？"},
    "option_texts": {"1": ["男", "女"]}
}

# 创建题型设置界面
question_settings = QuestionSettingsUI(root, config)

# 运行
root.mainloop()
```

### 获取配置
```python
# 获取当前配置
current_config = question_settings.get_config()

# 更新配置
new_config = {...}
question_settings.update_config(new_config)
```

## 优势特点

### 1. 模块化设计
- 独立的UI组件，易于集成
- 清晰的接口定义
- 可扩展的架构

### 2. 用户体验
- 直观的界面布局
- 丰富的交互功能
- 实时的视觉反馈

### 3. 功能完整性
- 支持所有主要题型
- 提供多种配置方式
- 智能的默认设置

### 4. 代码质量
- 清晰的代码结构
- 完善的错误处理
- 详细的文档说明

## 后续改进建议

### 1. 功能扩展
- 添加更多题型支持
- 增加配置导入/导出功能
- 实现配置模板系统

### 2. 界面优化
- 添加主题切换功能
- 实现响应式布局
- 增加动画效果

### 3. 性能优化
- 大数据量时的性能优化
- 内存使用优化
- 启动速度优化

### 4. 用户体验
- 添加快捷键支持
- 实现撤销/重做功能
- 增加操作提示

## 总结

通过基于 `cankao.py` 的设计，我们成功实现了一个功能完整、用户友好的题型设置界面。该界面不仅保持了原有设计的优点，还进行了模块化重构，提高了代码的可维护性和扩展性。

新的题型设置界面为问卷星系统提供了强大的配置能力，支持各种复杂题型的概率设置，为用户提供了灵活而直观的操作体验。
